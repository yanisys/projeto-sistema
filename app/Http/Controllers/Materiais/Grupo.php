<?phpnamespace App\Http\Controllers\Materiais;use App\Mail\mailTeste;use Illuminate\Support\Facades\DB;use Illuminate\Http\Request;use App\Http\Controllers\Controller;use Illuminate\Support\Facades\Log;class Grupo extends Controller{    public function __construct(){        $this->middleware('auth');        $this->middleware('configuraSessao');        $this->middleware('requestFilter');    }    public function listar(){        verficaPermissao('recurso.materiais/grupo');        $data['headerText'] = 'Grupos de produtos';        $data['breadcrumbs'][] = ['titulo' => 'InÃ­cio', 'href' => route('home')];        $data['breadcrumbs'][] = ['titulo' => 'Materiais', 'href' => route('materiais/produtos')];        $data['breadcrumbs'][] = ['titulo' => 'Grupos', 'href' => route('materiais/grupo/lista')];        if ($_REQUEST) {            $where[] = ['pd.cd_estabelecimento',session('estabelecimento')];            if (!empty($_REQUEST['nm_produto_divisao'])) {                $where[] = ['nm_produto_divisao', 'like', '%'.strtoupper($_REQUEST['nm_produto_divisao']).'%'];            }            $data['divisao'] = DB::table('produto_divisao as pd')                ->where($where)                ->orderBy('pd.cd_produto_divisao')                ->paginate(30)                ->appends($_REQUEST);            $data['grupo'] = DB::table('produto_grupo as pg')                ->leftJoin('produto_divisao as pd','pd.cd_produto_divisao','pg.cd_produto_divisao')                ->where($where)                ->orderBy('pg.cd_produto_grupo')                ->paginate(30)                ->appends($_REQUEST);            $data['sub_grupo'] = DB::table('produto_sub_grupo as psg')                ->leftJoin('produto_grupo as pg','pg.cd_produto_grupo','psg.cd_produto_grupo')                ->leftJoin('produto_divisao as pd','pd.cd_produto_divisao','pg.cd_produto_divisao')                ->where($where)                ->orderBy('psg.cd_produto_sub_grupo')                ->paginate(30)                ->appends($_REQUEST);        }        return view('materiais/grupo/lista', $data);    }    public function salvar_grupo_produto(Request $request){        verficaPermissao('recurso.materiais/grupo');        if(!isset($request['id'])) {            if (isset($request['superior'])) {                $dados['cd_produto_' . $request['superior']] = $request['cd_mestre'];            } else {                $dados['cd_estabelecimento'] = session('estabelecimento');            }        }        else{            $dados['cd_produto_'. $request['tabela']] = $request['id'];        }        $dados['nm_produto_'.strtolower($request['tabela'])] = $request['nome'];        DB::table('produto_'.strtolower($request['tabela']))->updateOrInsert(['cd_produto_'. strtolower($request['tabela'])=>$request['id']], $dados);        return json_encode(['success' => true]);    }    public function remover(Request $request){        try {            $data['lista'] = DB::table('produto')->where('cd_produto', '=', $_POST['cd_produto'])->where('cd_estabelecimento', '=', session()->get('estabelecimento'))->delete();            return redirect($_REQUEST['REFERER']);        } catch(\Illuminate\Database\QueryException $ex){            return redirect($_REQUEST['REFERER']);        }    }}